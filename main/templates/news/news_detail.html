{% extends 'base.html' %}
{% load tz %}
{% load static %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/news_detail.css' %}">
{% endblock %}

{% block content %}
    <div class="news-detail-container">
        <article class="news-article">
            <header class="news-header">
                <h1 class="news-title">{{ news.title }}</h1>
                <div class="news-meta">
                    {% if news.author %}
                        <span class="author">
                    <i class="fas fa-user"></i> {{ news.author.get_full_name|default:news.author.username }}
                </span>
                    {% endif %}
                    <span class="date">
                    <i class="far fa-clock"></i> {{ news.date|localtime|date:"d.m.Y H:i" }}
                </span>
                </div>
            </header>

            {% with featured_image=news.featured_image %}
                {% if featured_image %}
                    <div class="featured-image">
                        <img src="{{ featured_image.image.url }}" alt="{{ news.title }}" class="main-image">
                        {% if featured_image.caption %}
                            <p class="image-caption">{{ featured_image.caption }}</p>
                        {% endif %}
                    </div>
                {% endif %}
            {% endwith %}

            <div class="news-content">
                {{ news.content|linebreaks }}
            </div>

            {% if news.images.count > 1 %}
                <section class="news-gallery">
                    <h2 class="gallery-title">Галерея</h2>
                    <div class="gallery-grid">
                        {% for image in news.images.all %}
                            {% if not image.is_featured %}
                                <div class="gallery-item" onclick="openModal({{ forloop.counter0 }})">
                                    <img src="{{ image.image.url }}" alt="{{ image.caption|default:'Фото галереи' }}"
                                         class="gallery-image">
                                    {% if image.caption %}
                                        <p class="gallery-caption">{{ image.caption }}</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            <div id="imageModal" class="modal">
                <span class="close" onclick="closeModal()">&times;</span>
                <span class="nav prev" onclick="changeImage(-1)">&#10094;</span>
                <span class="nav next" onclick="changeImage(1)">&#10095;</span>
                <div class="modal-content">
                    <img id="modalImage" src="" alt="Просмотр изображения">
                </div>
                <div class="modal-caption" id="modalCaption"></div>
            </div>

            <footer class="news-footer">
                <a href="{% url 'news' %}" class="back-link">
                    <i class="fas fa-arrow-left"></i> Вернуться к списку новостей
                </a>
            </footer>
        </article>
    </div>



    <script>
        // Массив данных изображений (URL и подписи)
        const galleryData = [
            {% for image in news.images.all %}
                {% if not image.is_featured %}
                    {
                        url: "{{ image.image.url }}",
                        caption: "{{ image.caption|default:''|escapejs }}"
                    },
                {% endif %}
            {% endfor %}
        ];

        let currentImageIndex = 0;

        // Открытие модального окна
        function openModal(index) {
            currentImageIndex = index;
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');

            modalImg.src = galleryData[index].url;
            modalCaption.textContent = galleryData[index].caption;

            document.getElementById('imageModal').style.display = "block";
            document.body.style.overflow = "hidden";
        }

        // Закрытие модального окна
        function closeModal() {
            document.getElementById('imageModal').style.display = "none";
            document.body.style.overflow = "auto";
        }

        // Переключение изображений
        function changeImage(n) {
            currentImageIndex += n;

            // Зацикливание навигации
            if (currentImageIndex >= galleryData.length) {
                currentImageIndex = 0;
            } else if (currentImageIndex < 0) {
                currentImageIndex = galleryData.length - 1;
            }

            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');

            modalImg.src = galleryData[currentImageIndex].url;
            modalCaption.textContent = galleryData[currentImageIndex].caption;
        }

        // Закрытие по клику вне изображения
        window.onclick = function (event) {
            if (event.target == document.getElementById('imageModal')) {
                closeModal();
            }
        }

        // Навигация клавиатурой
        document.addEventListener('keydown', function (event) {
            const modal = document.getElementById('imageModal');
            if (modal.style.display === "block") {
                if (event.key === 'ArrowLeft') {
                    changeImage(-1);
                } else if (event.key === 'ArrowRight') {
                    changeImage(1);
                } else if (event.key === 'Escape') {
                    closeModal();
                }
            }
        });
    </script>

    <!-- Подключаем Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}